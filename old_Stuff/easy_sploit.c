#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_PEOPLE 100
#define DEBUG 1

typedef struct Y {
	char *y;
	int length;
} string;

typedef struct X {
	int         id;
	char*     name;
	char*  address;
	int     number;
	string* comments;
} contact;

contact* people[MAX_PEOPLE];
contact* free_people[MAX_PEOPLE];

int id = 0;

int consumetoendofline(FILE *where) {
    int ch;
    while (((ch = fgetc(where)) != '\n') && (ch != EOF)) /* void */;
    return ch;
}

void print_str(char *x){
	printf("%s\n", x);
}

int read_log_file(){
	return 0;
}

int read_number(){
	char* y = malloc(5);
	char *x = fgets(y, 19, stdin);
	int h = atoi(x);
	return h;
}

int find_id(){
	int i = 0;
	for(; i < MAX_PEOPLE; ++i){
		if(!people[i]){
			return i;
		}
	}
	return MAX_PEOPLE+1;
}

int find_id_free(){
	int i = 0;
	for(; i < MAX_PEOPLE; ++i){
		if(!free_people[i]){
			return i;
		}
	}
	return MAX_PEOPLE+1;
}

int find_free(){
	int i = 0;
	for(; i < MAX_PEOPLE; ++i){
		if(free_people[i]){
			return i;
		}
	}
	return -1;
}

contact* person_constructor(){
	char* y;
	contact* person = malloc(sizeof(contact));

	if(!person){
		print_str("OUT OF MEMORY");
		exit(1);
	}
	memset(person, 0, sizeof(contact));
	person->id = find_id();

	consumetoendofline(stdin);

	print_str("ENTER NAME: ");
	y = malloc(20);
	person->name = fgets(y, 19, stdin);
	print_str("ENTER Address: ");

	y = malloc(20);
	person->address = fgets(y, 19, stdin);

	print_str("ENTER PHONE #: ");
	person->number = read_number();
	print_str("ENTER COMMENTS: ");

	person->comments = malloc(sizeof(string));
	person->comments->y = malloc(sizeof(contact));
	person->comments->y = fgets(malloc(sizeof(contact)), 200, stdin);
	person->comments->length = strlen(person->comments->y);

	return person;
}

void add_person(){
	int x = find_free();
	if(x != -1){
		char* y;
		contact* person = free_people[x];

		print_str("ENTER NAME: ");
		y = malloc(20);
		person->name = fgets(y, 19, stdin);
		print_str("ENTER Address: ");

		y = malloc(20);
		person->address = fgets(y, 19, stdin);

		print_str("ENTER PHONE #: ");
		person->number = read_number();
		print_str("ENTER COMMENTS: ");

		person->comments = malloc(sizeof(string));
		person->comments->y = malloc(sizeof(contact));
		person->comments->y = fgets(malloc(sizeof(contact)), sizeof(contact), stdin);
		person->comments->length = strlen(person->comments->y);

		person->id = find_id();
		people[person->id] = person;
		free_people[x] = 0;
		return;
	}
	contact* person = person_constructor();
	if(person->id > MAX_PEOPLE){
		print_str("TOO MANY PEOPLE DELETE SOME FIRST");
		return;
	}
	printf("ADDING PERSON %s : %s: %d\n",person->name,person->address, person->number);
	people[person->id] = person;
}

void list_people(){
	int i = 0;
	for(; i < MAX_PEOPLE; ++i){
		if(people[i]){
			printf("ID: %d\n", people[i]->id);
			print_str(people[i]->name);
		}
	}
	return;
}

void edit_person(){
	print_str("ENTER ID:");
	int x = read_number();
	char p[20];
	string comment;

	if(x < 0 ||  x > MAX_PEOPLE)
		return;
	if(!people[x])
		print_str("INVALID ID");
	contact *person = people[x];

	print_str("1)EDIT NAME\n2)EDIT ADDRESS\n3)EDIT #\n4)EDIT COMMENT");
	x = read_number();
	switch(x){
		case 1:
			person->name = fgets(person->name, 20, stdin);
			break;
		case 2:
			person->address = fgets(person->address, 20, stdin);
			break;	
		case 3:
			person->number = read_number();
			break;		
		case 4:
			memset(person->comments->y, 0, person->comments->length);
			comment.y = p;
			fgets(comment.y, sizeof(contact)*4, stdin);
			person->comments->y = comment.y;
			person->comments->length = comment.length;
			break;
		default:
			return;
	}

	return;
}

void print_person(){
	print_str("ENTER ID:");
	int x = read_number();
	if(x < 0 ||  x > MAX_PEOPLE)
		return;
	if(!people[x]){
		print_str("INVALID ID");
		return;
	}
	contact *person = people[x];
	printf("NAME: %sADDRESS: %sID: %d \n", person->name, person->address, person->id);
	int i;
	for(i = 0; i < person->comments->length && i < MAX_PEOPLE * 4; ++i){
		printf("%c", person->comments->y[i]);
	}
	return;
}

void remove_person(){
	print_str("ENTER ID:");
	int x = read_number();
	if(x < 0 ||  x > MAX_PEOPLE)
		return;
	if(!people[x]){
		print_str("INVALID ID");
		return;
	}
	contact *person = people[x];
	int k = find_id_free();
	free(person->name);
	free(person->address);
	person->number = 0;

	contact* perso2 = malloc(sizeof(contact));
	memcpy(perso2, person, sizeof(contact));
	free_people[k] = person;

	free(person);
	people[x] = 0;
	return;
}

void start(){
	char* menu = "1) Add New\n2) List\n3) Edit Person\n4) Print Person\n5) Remove Person";
	print_str(menu);
	int x = read_number();
	switch(x){
		case 1: 
			add_person();
			break;
		case 2:
			list_people();
			break;		
		case 3:
			edit_person();
			break;		
		case 4:
			print_person();
			break;		
		case 5:
			remove_person();
			break;
		default:
			break;
	}

}

int main(){
	char* menu = "Contact System!\n 1) Load File [future not now] 2) Start New";
	print_str(menu);
	int x = read_number();
	if(x == 1){
		read_log_file();
		start();
	}
	else if(x == 2){
		while(1){
			start();
		}
	} else{
		print_str("Bad selection");
		main();
	}
}